"use strict";(self.webpackChunkwww=self.webpackChunkwww||[]).push([[7893],{550:function(n,s,a){a.r(s),a.d(s,{default:function(){return _}});var t=a(1151),e=a(7294);function p(n){const s=Object.assign({h1:"h1",a:"a",span:"span",p:"p",img:"img"},(0,t.ah)(),n.components);return e.createElement(e.Fragment,null,e.createElement(s.h1,{id:"python-and-alienvault",style:{position:"relative"}},e.createElement(s.a,{href:"#python-and-alienvault","aria-label":"python and alienvault permalink",className:"heading-anchor before"},e.createElement(s.span,{dangerouslySetInnerHTML:{__html:"<span>#</span>"}})),"Python and Alienvault"),"\n",e.createElement(s.p,null,"I recently identified the need to perform a triage on several hundred IPs extracted from a log that was not associated with any SIEM or CTI solution. To address this, I utilized simple scripting techniques to compile the data into a user-friendly list of IPs for Python to interpret. Despite my efforts to locate a suitable tool for this purpose, the majority of my findings consisted of outdated and extensive codebases, making it difficult to pinpoint my specific requirements. As a result, I seized the opportunity to write a simple tool to meet my needs. Although the code may not be aesthetically pleasing, it effectively provides the necessary feedback. I am confident that this code snippet can be of great value to others facing similar challenges, and the best part is that it does not require any prior coding experience to utilize and generate results. Just add in your Alienvault API key and the list of IPs as commented in the code and run it like any other python script."),"\n",e.createElement(s.p,null,"This script performs a comprehensive analysis of each IP address provided, cross-referencing it with information from AlienVault. Specifically, it examines any suspicious activity within the malware section that occurred within the timeframe defined by the variable lookback (which is currently set to 30 days). Upon completion of the analysis, each IP address is stored in the designated file ",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">ips.txt</code>'}}),"."),"\n",e.createElement(s.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime<span class="token punctuation">,</span> timedelta\n<span class="token keyword">import</span> json\n<span class="token keyword">import</span> requests\n<span class="token keyword">import</span> os\n<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures\n\nlookback <span class="token operator">=</span> <span class="token number">30</span>\n\n<span class="token keyword">import</span> os\n\nfilename <span class="token operator">=</span> <span class="token string">\'ips.txt\'</span>\n<span class="token comment"># Create file if not existing</span>\n<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">\'w\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>\n\n<span class="token comment"># Insert your AlienVault API key</span>\nAPI_KEY <span class="token operator">=</span> <span class="token string">""</span>\n\n<span class="token comment"># Insert a list of IP addresses to check</span>\nips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n\n\nOTX_API_ENDPOINT <span class="token operator">=</span> <span class="token string">"https://otx.alienvault.com/api/v1/indicators/IPv6/{ip}/{malware}"</span>\nHEADERS <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"X-OTX-API-KEY"</span><span class="token punctuation">:</span> API_KEY<span class="token punctuation">}</span>\n\n<span class="token keyword">def</span> <span class="token function">check_date</span><span class="token punctuation">(</span>date_str<span class="token punctuation">)</span><span class="token punctuation">:</span>\n    date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>date_str<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">\'T\'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">\'%Y-%m-%d\'</span><span class="token punctuation">)</span>\n    delta <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> date\n    <span class="token keyword">if</span> delta <span class="token operator">&lt;</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span>lookback<span class="token punctuation">)</span><span class="token punctuation">:</span>\n        <span class="token keyword">return</span> <span class="token boolean">True</span>\n\ntriage_ips <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'ips.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'r\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    existing_ips <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\n<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">\'ips.txt\'</span><span class="token punctuation">,</span> <span class="token string">\'a\'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>\n    <span class="token keyword">with</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>\n        <span class="token keyword">def</span> <span class="token function">process_ip</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">:</span>\n            <span class="token keyword">if</span> ip <span class="token keyword">in</span> existing_ips<span class="token punctuation">:</span>\n                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Skipping </span><span class="token interpolation"><span class="token punctuation">{</span>ip<span class="token punctuation">}</span></span><span class="token string"> as it already exists in the file"</span></span><span class="token punctuation">)</span>\n                <span class="token keyword">return</span>\n\n            <span class="token keyword">try</span><span class="token punctuation">:</span>\n                <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"https://otx.alienvault.com/api/v1/indicators/IPv4/</span><span class="token interpolation"><span class="token punctuation">{</span>ip<span class="token punctuation">}</span></span><span class="token string">/reputation"</span></span><span class="token punctuation">,</span> stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">as</span> reputation<span class="token punctuation">:</span>\n                    reputation<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>\n                    reputation_data <span class="token operator">=</span> reputation<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>\n                <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"https://otx.alienvault.com/api/v1/indicators/IPv4/</span><span class="token interpolation"><span class="token punctuation">{</span>ip<span class="token punctuation">}</span></span><span class="token string">/malware"</span></span><span class="token punctuation">,</span> stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">as</span> malware<span class="token punctuation">:</span>\n                    malware<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>\n                    malware_data <span class="token operator">=</span> malware<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>\n                    date_values <span class="token operator">=</span> <span class="token punctuation">[</span>d<span class="token punctuation">[</span><span class="token string">\'date\'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> d <span class="token keyword">in</span> malware_data<span class="token punctuation">[</span><span class="token string">\'data\'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>\n                    <span class="token keyword">for</span> date <span class="token keyword">in</span> date_values<span class="token punctuation">:</span>\n                        <span class="token keyword">if</span> check_date<span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">:</span>\n                            triage_ips<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ip<span class="token punctuation">)</span>\n                            <span class="token keyword">print</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span>\n                            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>ip<span class="token punctuation">}</span></span><span class="token string">\\n"</span></span><span class="token punctuation">)</span>\n                            <span class="token keyword">break</span>\n            <span class="token keyword">except</span> requests<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>\n                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string"> for </span><span class="token interpolation"><span class="token punctuation">{</span>ip<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>\n            <span class="token keyword">except</span> json<span class="token punctuation">.</span>decoder<span class="token punctuation">.</span>JSONDecodeError<span class="token punctuation">:</span>\n                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error: JSON decoding failed for </span><span class="token interpolation"><span class="token punctuation">{</span>ip<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>\n\n        <span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>\n            executor<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>process_ip<span class="token punctuation">,</span> ips<span class="token punctuation">)</span>\n\n<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Triage these IPs:"</span><span class="token punctuation">,</span> triage_ips<span class="token punctuation">)</span>\n</code></pre></div>'}}),"\n",e.createElement(s.p,null,"Moving forward, it would be interesting to add a few triage levels based on different lookbacks stored in separate files for 7 days, 14 days and 30 days and possibly avoid duplicates between them (where the most recent IP activity gets precedense)."),"\n",e.createElement(s.p,null,"Any additions or suggestions, please reach out through ",e.createElement(s.img,{src:"https://github.com/amestofortytwo/python_snippets",alt:"github"})," issues or any other SoMe."))}var o=function(n){void 0===n&&(n={});const{wrapper:s}=Object.assign({},(0,t.ah)(),n.components);return s?e.createElement(s,n,e.createElement(p,n)):p(n)},c=a(1883),l=a(9352),i=a(8032),r=a(7896),u=a(5916),k=a(197),d=a(5911),m=a(8762),g=a(9586),y=a(9951),f=a(9286),h=a(2271),w=a(5437),b=a(5555),x=a(5648),E=a(7660),v=a(8188);const N=n=>{let{image:s}=n;return s?e.createElement(i.G,{className:"gatsby-resp-image-image",image:s,alt:""}):null},I=n=>{let{data:{mdx:{body:s,tableOfContents:a,frontmatter:{author:p,title:o,date:I,categories:_,hero:P,description:T,keywords:j},fields:{slug:A},timeToRead:Z,relatedPosts:S}},pageContext:{tableOfContentsLevels:O,previous:C,next:L},children:q}=n;const M=(0,e.useRef)(null),R=(0,i.c)(null==P?void 0:P.medium),{siteUrl:$}=(0,x.$W)(),{href:z}=(0,r.useLocation)(),D=p.map((n=>{let{id:s,yamlId:a,name:t,bio:e,sns:p}=n;return{id:s,yamlId:a,name:t,bio:e,socialUrls:p.filter((n=>"mailto"!=n[0]&&"url"!=n[0])).map((n=>`${E.$s[n[0]].url}/${n[1]}`))}}));return e.createElement(u.Z,{postDescription:T,pageImage:R.images.fallback.src,pageUrl:`${$}${A}`,postTitle:o,pageTitle:o,keywords:j,date:I,timeToRead:Z,authors:D},e.createElement(h.Z,{ref:M}),e.createElement("div",{className:"hidden md:block"},e.createElement(w.Z,{className:"fixed right-[6%] bottom-[6%] flex flex-col justify-center z-50"},e.createElement(y.Z,null))),e.createElement("div",{className:"max-w-lg md:max-w-2xl mx-auto mb-24"},e.createElement("h1",{className:"text-center"},o),e.createElement(k.Z,{className:"block mb-4 text-center",date:I,timeToRead:Z}),e.createElement("div",{className:"block sm:flex flex-wrap items-center justify-center sm:justify-between"},e.createElement(f.Z,{data:p}),e.createElement(m.Z,{url:z,title:o,hashtags:_.join(","),description:T,className:"space-x-6 text-xl py-4 justify-center",twitter:!0,facebook:!0,linkedin:!0,pocket:!0,copy:!0}))),e.createElement("div",{className:"text-center mb-24"},e.createElement(N,{image:R})),e.createElement("div",{className:"lg:grid lg:grid-cols-9 lg:gaps-5"},e.createElement(m.Z,{url:z,title:o,hashtags:_.join(","),description:T,className:"hidden lg:flex text-xl mt-12 flex-col lg:col-start-1 lg:col-end-3 top-[2rem] sticky self-start max-h-full overflow-y-auto space-y-6",twitter:!0,facebook:!0,linkedin:!0,pocket:!0,copy:!0}),e.createElement("article",{className:"markdown lg:col-start-3 lg:col-end-8",ref:M},e.createElement(t.Zo,{components:{}},q)),e.createElement(b.Z,{className:"hidden lg:block lg:col-span-2 mt-12 top-[2rem] sticky self-start text-xs font-semibold ml-12 mr-auto mb-6 overflow-y-auto max-h-full",items:a.items,ref:M,levels:O})),e.createElement("div",{className:"my-8 max-w-lg md:max-w-2xl mx-auto"},e.createElement("div",{className:"block sm:flex flex-wrap items-center justify-center sm:justify-between"},e.createElement(g.Z,{className:"my-8 justify-center",categories:_}),e.createElement(m.Z,{url:z,title:o,hashtags:_.join(","),description:T,className:"space-x-6 text-xl my-8 justify-center",twitter:!0,facebook:!0,linkedin:!0,pocket:!0,copy:!0})),e.createElement("div",{className:"flex justify-around flex-wrap text-base mt-12 mb-24"},e.createElement("div",{className:"p-4 my-4 bg-gray-50 border border-solid border-gray-100 dark:bg-gray-800 dark:border-gray-800 rounded mr-auto w-full md:w-[49%]"},e.createElement(c.Link,{to:C.slug,className:"site-link my-2 block"},e.createElement("div",{className:"flex items-start space-x-2"},e.createElement(l.YG0,{className:"block h-6 w-6"}),e.createElement("span",null,C.title)))),e.createElement("div",{className:"p-4 my-4 bg-gray-50 border border-solid border-gray-100 dark:bg-gray-800 dark:border-gray-800 rounded ml-auto w-full md:w-[49%]"},e.createElement(c.Link,{to:L.slug,className:"site-link my-2 block text-right"},e.createElement("div",{className:"flex items-start space-x-2 justify-end"},e.createElement("span",null,L.title),e.createElement(l.nzV,{className:"block h-6 w-6"}))))),e.createElement("h5",{className:"text-center mb-12"},"Written by"),p.map((n=>{let{bio:s,name:a,initial:t,avatar:p,sns:o,yamlId:c}=n;return e.createElement(d.Z,{className:"p-8 mb-4 bg-gray-50 border border-solid border-gray-100 dark:bg-gray-800 dark:border-gray-800 rounded",key:c,bio:s,name:a,initial:t,avatar:p,sns:o,yamlId:c})}))),e.createElement("div",{className:"my-24 max-w-lg sm:max-w-full mx-auto"},e.createElement("h5",{className:"mb-12 text-center"},"Related Posts"),e.createElement(v.Z,{posts:S,className:"grid sm:grid-cols-3 row-auto auto-cols-auto gap-8"})))};function _(n){return e.createElement(I,n,e.createElement(o,n))}}}]);
//# sourceMappingURL=component---node-modules-pitayan-gatsby-theme-pitayan-src-templates-post-index-tsx-content-file-path-content-posts-2023-03-12-bulk-triage-ips-with-alienvault-and-python-index-mdx-3117f1cf1ac1748de3d5.js.map